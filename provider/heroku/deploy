#!/bin/bash
set -eo pipefail

_DIR_="$(dirname "$0")"
cd $_DIR_

. helpers.sh

echo "-----> Initializing application space..."
# heroku login has issues inside script, ssh keys are obsolete if this works
#expect <<END
#  spawn heroku login
#  expect {
#    -re "Email.*" { send "$HEROKU_USERNAME\r"; exp_continue } 
#    -re "Password \(typing will be hidden\):" { send "$HEROKU_PASSWORD\r" }
#  }
#END
export HEROKU_API_KEY=$HEROKU_API_KEY

# ssh key upload
heroku keys:add

# create app space, no ssh keys needed when using http git
heroku create $APPNAME --ssh-git

# set env vars
if [[ !${#evar[@]} -eq 0 ]]; then
  heroku config:set ${evar[@]}
fi

echo "-----> Deploying application..."
expect <<'END'
  set timeout 1000
  spawn git push heroku master
  expect {
    -re ".*continue connecting (yes/no)?" { send "yes\r" }
  }
  expect eof
END

echo "-----> Checking availability..."
is_up "https://$APPNAME.herokuapp.com"

