#!/bin/bash
set -eo pipefail

_DIR_="$(dirname "$0")"
cd $_DIR_

. helpers.sh

echo "-----> Initializing application space..."
. eb_init.sh

echo "-----> Deploying application..."
# FIXME --polling-timeout 1800 is bugged
# will timeout too early like this
# See https://forums.aws.amazon.com/message.jspa?messageID=562409#562409
eb start --verbose <<EOF
y
EOF

# wait for instance to be ready
printf "Waiting for instance to be ready again"

until [ "$(eb status | sed -En "s/Status.*?: (.*)$/\1/p")" == "Ready" ]; do
  printf "."
  sleep 1
done

printf "\n"

echo "-----> Checking availability..."
url=$(eb status | sed -En "s/URL.*?: (.*)$/\1/p")
is_up $url

